#include <stdio.h>
#include <stdint.h>

#include "stm32f4xx_conf.h"
#include "stm32f4xx.h"

#include "usbd_core.h"
#include "usbd_usr.h"
#include "usbd_desc.h"
#include "usbd_cdc_vcp.h"

#include "console.h"
#include "galvo.h"

#define BLINK_DELAY_MS	(500)

volatile uint32_t tickMs = 0;
__ALIGN_BEGIN USB_OTG_CORE_HANDLE  USB_OTG_dev __ALIGN_END;

// Private function prototypes
void Delay(volatile uint32_t nCount);
void init();

#define XOFFMAX (500)
#define XOFFMIN (-50)
#define YOFFMAX (500)
#define YOFFMIN (-50)

typedef enum {
	MOVING = 0,
	DRAWING,
} state_t;

#define MOVING_PERIOD (25)

static state_t currentState = MOVING;
static uint32_t movingDelay = MOVING_PERIOD;

typedef struct {
	uint16_t x;
	uint16_t y;
} path_t;

path_t path0[] = {{1136, 1764}, {1158, 1734}, {1163, 1724}, {1167, 1719}, {1176, 1704}, {1181, 1700}, {1181, 1690}, {1190, 1675}, {1190, 1665}, {1194, 1655}, {1208, 1625}, {1212, 1616}, {1212, 1606}, {1222, 1596}, {1222, 1586}, {1231, 1576}, {1235, 1566}, {1244, 1556}, {1249, 1546}, {1258, 1537}, {1262, 1532}, {1271, 1527}, {1276, 1522}, {1285, 1517}, {1294, 1507}, {1298, 1502}, {1312, 1497}, {1321, 1487}, {1335, 1477}, {1353, 1467}, {1375, 1448}, {1389, 1443}, {1398, 1433}, {1430, 1413}, {1448, 1398}, {1457, 1388}, {1479, 1374}, {1484, 1369}, {1507, 1344}, {1516, 1339}, {1525, 1329}, {1534, 1319}, {1538, 1314}, {1543, 1304}, {1565, 1294}, {1575, 1285}, {1597, 1265}, {1638, 1240}, {1656, 1230}, {1665, 1225}, {1674, 1225}, {1701, 1220}, {1724, 1215}, {1742, 1210}, {1760, 1210}, {1774, 1206}, {1805, 1206}, {1823, 1201}, {1842, 1201}, {1891, 1191}, {1914, 1186}, {1928, 1186}, {1946, 1181}, {1959, 1181}, {1968, 1181}, {1977, 1176}, {1986, 1176}, {2018, 1176}, {2054, 1176}, {2068, 1176}, {2086, 1181}, {2100, 1181}, {2109, 1186}, {2127, 1186}, {2136, 1191}, {2145, 1191}, {2154, 1196}, {2167, 1196}, {2181, 1201}, {2195, 1201}, {2213, 1210}, {2226, 1210}, {2258, 1225}, {2267, 1230}, {2272, 1235}, {2294, 1245}, {2299, 1250}, {2303, 1250}, {2308, 1255}, {2326, 1260}, {2339, 1265}, {2353, 1270}, {2367, 1280}, {2380, 1285}, {2389, 1290}, {2398, 1290}, {2407, 1294}, {2412, 1294}, {2421, 1299}, {2425, 1304}, {2439, 1309}, {2444, 1309}, {2453, 1314}, {2462, 1319}, {2475, 1329}, {2498, 1339}, {2520, 1354}, {2525, 1359}, {2534, 1359}, {2548, 1374}, {2557, 1378}, {2561, 1388}, {2570, 1393}, {2584, 1408}, {2593, 1413}, {2602, 1423}, {2611, 1433}, {2620, 1443}, {2625, 1448}, {2629, 1457}, {2634, 1457}, {2638, 1467}, {2643, 1472}, {2652, 1487}, {2656, 1497}, {2661, 1502}, {2679, 1532}, {2692, 1551}, {2711, 1581}, {2729, 1606}, {2738, 1616}, {2742, 1630}, {2751, 1640}, {2751, 1645}, {2756, 1650}, {2760, 1660}, {2774, 1690}, {2783, 1705}, {2788, 1709}, {2792, 1724}, {2797, 1734}, {2801, 1749}, {2819, 1788}, {2828, 1798}, {2828, 1808}, {2833, 1813}, {2833, 1818}, {2837, 1823}, {2837, 1833}, {2842, 1838}, {2842, 1848}, {2851, 1868}, {2855, 1882}, {2860, 1902}, {2869, 1917}, {2873, 1937}, {2878, 1947}, {2883, 1961}, {2887, 1971}, {2887, 1976}, {2892, 1981}, {2892, 1986}, {2892, 1996}, {2896, 2011}, {2896, 2026}, {2896, 2040}, {2896, 2050}, {2901, 2070}, {2901, 2110}, {2901, 2119}, {2905, 2134}, {2905, 2149}, {2905, 2199}, {2905, 2218}, {2905, 2243}, {2901, 2263}, {2901, 2282}, {2901, 2307}, {2901, 2327}, {2896, 2347}, {2892, 2371}, {2892, 2391}, {2887, 2406}, {2887, 2431}, {2883, 2441}, {2883, 2455}, {2878, 2470}, {2869, 2520}, {2860, 2544}, {2860, 2559}, {2851, 2579}, {2846, 2599}, {2837, 2623}, {2824, 2683}, {2819, 2693}, {2806, 2722}, {2801, 2732}, {2797, 2747}, {2783, 2767}, {2769, 2791}, {2760, 2801}, {2751, 2821}, {2738, 2841}, {2729, 2860}, {2706, 2895}, {2697, 2915}, {2679, 2940}, {2670, 2959}, {2665, 2964}, {2661, 2974}, {2647, 2989}, {2643, 3004}, {2638, 3009}, {2634, 3019}, {2629, 3024}, {2629, 3038}, {2620, 3058}, {2616, 3078}, {2606, 3117}, {2597, 3142}, {2593, 3162}, {2584, 3206}, {2584, 3221}, {2579, 3236}, {2579, 3251}, {2575, 3266}, {2575, 3271}, {2570, 3275}, {2570, 3295}, {2566, 3300}, {2566, 3310}, {2561, 3315}, {2561, 3320}, {2557, 3325}, {2552, 3330}, {2543, 3340}, {2507, 3350}, {2498, 3354}, {2471, 3364}, {2444, 3379}, {2439, 3384}, {2430, 3384}, {2425, 3389}, {2407, 3389}, {2403, 3394}, {2394, 3394}, {2385, 3394}, {2358, 3394}, {2339, 3394}, {2335, 3379}, {2326, 3369}, {2326, 3364}, {2321, 3354}, {2321, 3335}, {2317, 3325}, {2317, 3295}, {2312, 3285}, {2308, 3261}, {2308, 3246}, {2303, 3236}, {2303, 3226}, {2294, 3216}, {2294, 3211}, {2290, 3206}, {2276, 3182}, {2272, 3182}, {2262, 3177}, {2249, 3177}, {2249, 3172}, {2244, 3172}, {2231, 3172}, {2231, 3177}, {2222, 3187}, {2222, 3196}, {2222, 3211}, {2217, 3221}, {2217, 3246}, {2217, 3300}, {2217, 3315}, {2217, 3330}, {2213, 3340}, {2208, 3354}, {2199, 3364}, {2190, 3389}, {2181, 3394}, {2181, 3404}, {2172, 3409}, {2167, 3414}, {2158, 3419}, {2154, 3424}, {2140, 3429}, {2127, 3434}, {2113, 3434}, {2100, 3434}, {2054, 3434}, {2014, 3434}, {2005, 3434}, {2000, 3434}, {1991, 3429}, {1982, 3424}, {1973, 3414}, {1968, 3414}, {1964, 3409}, {1955, 3404}, {1950, 3394}, {1937, 3379}, {1932, 3379}, {1932, 3374}, {1928, 3369}, {1928, 3364}, {1923, 3354}, {1919, 3340}, {1909, 3330}, {1909, 3315}, {1900, 3295}, {1900, 3271}, {1896, 3256}, {1896, 3241}, {1896, 3221}, {1896, 3211}, {1891, 3201}, {1891, 3191}, {1887, 3187}, {1887, 3177}, {1882, 3177}, {1873, 3167}, {1851, 3167}, {1833, 3167}, {1819, 3187}, {1819, 3196}, {1814, 3206}, {1814, 3211}, {1810, 3226}, {1810, 3246}, {1805, 3256}, {1805, 3266}, {1801, 3290}, {1792, 3320}, {1792, 3335}, {1787, 3345}, {1783, 3354}, {1774, 3374}, {1769, 3379}, {1765, 3389}, {1742, 3414}, {1733, 3419}, {1724, 3424}, {1710, 3424}, {1688, 3424}, {1647, 3424}, {1611, 3424}, {1597, 3424}, {1593, 3419}, {1588, 3419}, {1584, 3414}, {1579, 3414}, {1575, 3409}, {1556, 3409}, {1538, 3399}, {1525, 3399}, {1525, 3394}, {1520, 3394}, {1511, 3379}, {1507, 3374}, {1507, 3345}, {1502, 3330}, {1502, 3315}, {1498, 3305}, {1498, 3290}, {1498, 3251}, {1498, 3241}, {1493, 3231}, {1493, 3221}, {1493, 3211}, {1493, 3206}, {1489, 3196}, {1489, 3191}, {1489, 3167}, {1484, 3152}, {1484, 3137}, {1479, 3122}, {1479, 3112}, {1475, 3103}, {1470, 3093}, {1466, 3088}, {1461, 3073}, {1443, 3048}, {1434, 3043}, {1425, 3033}, {1403, 3019}, {1389, 3009}, {1380, 3004}, {1366, 2989}, {1357, 2974}, {1344, 2964}, {1326, 2949}, {1312, 2935}, {1298, 2920}, {1289, 2905}, {1280, 2895}, {1276, 2885}, {1267, 2875}, {1262, 2860}, {1253, 2846}, {1253, 2841}, {1244, 2826}, {1240, 2811}, {1231, 2796}, {1221, 2777}, {1203, 2757}, {1203, 2752}, {1190, 2732}, {1185, 2727}, {1181, 2717}, {1167, 2702}, {1163, 2693}, {1158, 2688}, {1149, 2663}, {1136, 2643}, {1131, 2628}, {1126, 2618}, {1122, 2604}, {1117, 2594}, {1117, 2584}, {1113, 2574}, {1113, 2564}, {1104, 2544}, {1104, 2525}, {1099, 2510}, {1099, 2495}, {1095, 2490}, {1095, 2485}, {1095, 2470}, {1090, 2460}, {1090, 2450}, {1090, 2431}, {1086, 2391}, {1077, 2347}, {1077, 2307}, {1072, 2287}, {1072, 2273}, {1068, 2258}, {1068, 2233}, {1063, 2218}, {1063, 2203}, {1063, 2184}, {1063, 2164}, {1059, 2144}, {1059, 2129}, {1059, 2115}, {1059, 2050}, {1059, 2011}, {1059, 1996}, {1063, 1966}, {1068, 1952}, {1072, 1932}, {1072, 1917}, {1077, 1897}, {1081, 1868}, {1086, 1858}, {1086, 1843}, {1090, 1838}, {1090, 1828}, {1095, 1828}, {1095, 1818}, {1104, 1803}, {1104, 1798}, {1108, 1788}, {1108, 1779}, {1113, 1774}, {1113, 1769}, {1117, 1759}, {1117, 1754}, {1136, 1764}, {1122, 1744}, {1126, 1744}, {1126, 1739}, {1131, 1734}, {1131, 1729}, {1136, 1724}, {1149, 1709}, {1154, 1705}, {1167, 1675}, {1172, 1670}, {1176, 1660}, {1185, 1650}, {1194, 1630}, {1199, 1625}, {1199, 1621}, {1203, 1621}, {1208, 1611}, {1212, 1611}, {1212, 1601}, {1222, 1591}, {1226, 1581}, {1231, 1576}, {1231, 1571}, {1235, 1561}, {1244, 1551}, {1244, 1541}, {1249, 1541}, {1249, 1537}, };
path_t path1[] = {{2380, 2001}, {2398, 1996}, {2416, 1996}, {2448, 1996}, {2475, 1996}, {2480, 1996}, {2484, 1996}, {2489, 2001}, {2502, 2001}, {2507, 2006}, {2516, 2006}, {2525, 2016}, {2530, 2016}, {2534, 2021}, {2539, 2021}, {2543, 2026}, {2552, 2031}, {2561, 2040}, {2570, 2040}, {2575, 2050}, {2584, 2050}, {2588, 2055}, {2597, 2060}, {2602, 2065}, {2611, 2065}, {2616, 2070}, {2620, 2070}, {2620, 2075}, {2625, 2075}, {2638, 2085}, {2647, 2090}, {2652, 2090}, {2652, 2095}, {2656, 2095}, {2661, 2105}, {2674, 2119}, {2679, 2129}, {2683, 2139}, {2683, 2144}, {2688, 2149}, {2688, 2154}, {2697, 2164}, {2697, 2169}, {2702, 2169}, {2702, 2174}, {2706, 2179}, {2706, 2184}, {2711, 2189}, {2711, 2194}, {2715, 2199}, {2715, 2203}, {2720, 2208}, {2720, 2213}, {2720, 2223}, {2720, 2248}, {2720, 2253}, {2720, 2258}, {2724, 2263}, {2724, 2282}, {2724, 2307}, {2729, 2312}, {2729, 2327}, {2733, 2327}, {2733, 2342}, {2738, 2347}, {2738, 2362}, {2742, 2371}, {2742, 2401}, {2742, 2406}, {2747, 2416}, {2747, 2421}, {2747, 2431}, {2742, 2441}, {2738, 2450}, {2733, 2455}, {2706, 2475}, {2697, 2485}, {2679, 2490}, {2670, 2495}, {2661, 2500}, {2656, 2505}, {2652, 2505}, {2643, 2510}, {2634, 2515}, {2629, 2520}, {2625, 2520}, {2620, 2525}, {2616, 2525}, {2611, 2530}, {2606, 2534}, {2606, 2539}, {2602, 2539}, {2593, 2544}, {2584, 2544}, {2561, 2544}, {2552, 2544}, {2543, 2544}, {2534, 2539}, {2525, 2534}, {2520, 2525}, {2516, 2525}, {2502, 2510}, {2502, 2505}, {2498, 2505}, {2498, 2500}, {2493, 2500}, {2493, 2495}, {2489, 2495}, {2484, 2485}, {2466, 2465}, {2462, 2465}, {2457, 2455}, {2453, 2455}, {2444, 2450}, {2444, 2446}, {2439, 2446}, {2434, 2441}, {2425, 2436}, {2398, 2421}, {2380, 2411}, {2367, 2401}, {2358, 2401}, {2353, 2396}, {2339, 2386}, {2330, 2381}, {2326, 2376}, {2317, 2376}, {2312, 2371}, {2308, 2371}, {2303, 2366}, {2290, 2357}, {2281, 2352}, {2272, 2347}, {2267, 2347}, {2262, 2342}, {2253, 2337}, {2249, 2332}, {2244, 2327}, {2244, 2322}, {2235, 2317}, {2231, 2307}, {2222, 2302}, {2204, 2282}, {2204, 2278}, {2195, 2268}, {2190, 2258}, {2186, 2258}, {2186, 2253}, {2181, 2243}, {2181, 2238}, {2176, 2233}, {2176, 2218}, {2172, 2213}, {2172, 2203}, {2172, 2194}, {2172, 2164}, {2176, 2154}, {2176, 2144}, {2190, 2115}, {2195, 2110}, {2204, 2085}, {2208, 2080}, {2217, 2065}, {2222, 2055}, {2231, 2050}, {2244, 2040}, {2253, 2035}, {2262, 2026}, {2276, 2021}, {2281, 2016}, {2294, 2011}, {2308, 2006}, {2321, 2001}, {2335, 1996}, {2358, 1996}, {2362, 1996}, {2362, 1991}, {2380, 2001}, };
path_t path2[] = {{1276, 3162}, {1258, 3182}, {1222, 3201}, {1217, 3206}, {1208, 3216}, {1199, 3226}, {1185, 3231}, {1172, 3246}, {1163, 3256}, {1158, 3261}, {1154, 3271}, {1145, 3275}, {1140, 3285}, {1136, 3285}, {1126, 3305}, {1117, 3315}, {1108, 3335}, {1099, 3345}, {1086, 3374}, {1086, 3379}, {1077, 3389}, {1072, 3394}, {1072, 3399}, {1059, 3429}, {1054, 3443}, {1045, 3458}, {1040, 3468}, {1031, 3478}, {1013, 3513}, {1004, 3542}, {1000, 3552}, {995, 3577}, {995, 3606}, {991, 3616}, {991, 3636}, {986, 3646}, {986, 3666}, {982, 3671}, {982, 3681}, {977, 3690}, {977, 3695}, {973, 3705}, {968, 3715}, {959, 3725}, {950, 3745}, {941, 3755}, {932, 3769}, {923, 3779}, {914, 3799}, {891, 3824}, {887, 3834}, {864, 3858}, {855, 3873}, {850, 3873}, {850, 3878}, {832, 3893}, {823, 3908}, {814, 3913}, {810, 3923}, {805, 3928}, {801, 3937}, {787, 3952}, {773, 3967}, {742, 3982}, {733, 3992}, {719, 3997}, {710, 4002}, {701, 4002}, {692, 4007}, {687, 4007}, {674, 4012}, {665, 4016}, {624, 4031}, {606, 4041}, {592, 4041}, {583, 4046}, {570, 4046}, {561, 4051}, {547, 4051}, {543, 4056}, {534, 4056}, {525, 4061}, {506, 4061}, {502, 4066}, {475, 4066}, {470, 4071}, {466, 4071}, {461, 4071}, {457, 4071}, {452, 4071}, {448, 4066}, {429, 4056}, {420, 4046}, {416, 4046}, {416, 4031}, {416, 4007}, {420, 4002}, {434, 3987}, {448, 3977}, {457, 3967}, {479, 3947}, {493, 3942}, {506, 3932}, {515, 3928}, {543, 3913}, {579, 3898}, {583, 3888}, {588, 3888}, {597, 3878}, {601, 3878}, {606, 3873}, {615, 3868}, {624, 3858}, {633, 3853}, {638, 3849}, {642, 3844}, {642, 3839}, {647, 3829}, {656, 3814}, {660, 3799}, {660, 3794}, {665, 3794}, {665, 3784}, {674, 3779}, {674, 3774}, {683, 3769}, {683, 3760}, {687, 3755}, {687, 3740}, {687, 3715}, {678, 3700}, {674, 3690}, {665, 3676}, {656, 3661}, {647, 3651}, {629, 3616}, {610, 3592}, {601, 3582}, {588, 3552}, {574, 3537}, {570, 3527}, {543, 3503}, {534, 3493}, {520, 3483}, {488, 3448}, {452, 3424}, {443, 3414}, {434, 3409}, {425, 3399}, {416, 3394}, {407, 3384}, {398, 3379}, {384, 3364}, {375, 3350}, {362, 3335}, {357, 3335}, {343, 3325}, {339, 3325}, {312, 3364}, {294, 3394}, {276, 3414}, {262, 3434}, {239, 3453}, {226, 3468}, {217, 3473}, {194, 3488}, {190, 3488}, {190, 3493}, {176, 3498}, {167, 3508}, {158, 3513}, {153, 3518}, {144, 3522}, {140, 3527}, {131, 3532}, {126, 3537}, {122, 3537}, {113, 3542}, {108, 3542}, {104, 3547}, {95, 3547}, {85, 3552}, {72, 3552}, {67, 3557}, {63, 3557}, {36, 3557}, {31, 3557}, {31, 3552}, {27, 3547}, {27, 3542}, {27, 3532}, {27, 3503}, {27, 3493}, {31, 3473}, {31, 3458}, {36, 3443}, {40, 3424}, {40, 3409}, {45, 3394}, {49, 3379}, {54, 3374}, {58, 3359}, {67, 3345}, {76, 3315}, {85, 3305}, {95, 3285}, {104, 3275}, {113, 3261}, {122, 3251}, {135, 3236}, {162, 3216}, {190, 3191}, {208, 3182}, {221, 3172}, {235, 3167}, {244, 3157}, {271, 3147}, {289, 3132}, {294, 3132}, {303, 3127}, {312, 3122}, {321, 3112}, {330, 3107}, {343, 3098}, {357, 3093}, {366, 3083}, {375, 3078}, {384, 3073}, {389, 3073}, {393, 3068}, {407, 3063}, {434, 3043}, {452, 3038}, {466, 3028}, {475, 3024}, {484, 3014}, {497, 3009}, {515, 2999}, {529, 2999}, {543, 2994}, {556, 2989}, {561, 2984}, {579, 2979}, {592, 2979}, {606, 2974}, {620, 2969}, {629, 2964}, {642, 2964}, {656, 2959}, {669, 2954}, {678, 2949}, {687, 2949}, {692, 2944}, {696, 2944}, {710, 2935}, {715, 2935}, {742, 2915}, {755, 2910}, {769, 2900}, {782, 2890}, {796, 2880}, {805, 2865}, {819, 2860}, {837, 2846}, {846, 2846}, {850, 2836}, {859, 2836}, {864, 2831}, {873, 2826}, {887, 2811}, {896, 2801}, {909, 2796}, {914, 2786}, {923, 2781}, {936, 2772}, {945, 2767}, {959, 2757}, {968, 2757}, {977, 2752}, {995, 2752}, {1027, 2776}, {1040, 2791}, {1050, 2806}, {1059, 2816}, {1068, 2836}, {1077, 2851}, {1090, 2870}, {1095, 2885}, {1104, 2895}, {1126, 2935}, {1140, 2949}, {1145, 2964}, {1158, 2979}, {1163, 2989}, {1172, 2999}, {1203, 3033}, {1212, 3043}, {1222, 3058}, {1231, 3063}, {1249, 3093}, {1262, 3107}, {1271, 3122}, {1276, 3122}, {1276, 3127}, {1280, 3132}, {1280, 3137}, {1285, 3142}, };
path_t path3[] = {{2588, 1166}, {2606, 1156}, {2611, 1156}, {2620, 1151}, {2638, 1136}, {2656, 1122}, {2674, 1102}, {2688, 1092}, {2706, 1077}, {2724, 1062}, {2742, 1043}, {2769, 1013}, {2792, 988}, {2806, 973}, {2824, 944}, {2837, 924}, {2842, 909}, {2851, 899}, {2860, 884}, {2869, 875}, {2878, 860}, {2887, 845}, {2892, 830}, {2901, 815}, {2905, 805}, {2914, 796}, {2919, 786}, {2928, 771}, {2937, 761}, {2946, 741}, {2955, 726}, {2959, 712}, {2973, 687}, {2978, 672}, {2987, 657}, {3005, 603}, {3014, 583}, {3018, 568}, {3027, 549}, {3032, 539}, {3036, 519}, {3045, 504}, {3050, 494}, {3059, 479}, {3086, 420}, {3095, 405}, {3100, 390}, {3109, 376}, {3118, 356}, {3127, 336}, {3136, 316}, {3150, 302}, {3159, 287}, {3172, 272}, {3190, 242}, {3204, 227}, {3217, 213}, {3236, 198}, {3276, 163}, {3285, 153}, {3313, 134}, {3335, 114}, {3371, 94}, {3385, 84}, {3412, 69}, {3439, 55}, {3457, 45}, {3516, 25}, {3539, 20}, {3570, 10}, {3593, 10}, {3607, 10}, {3611, 15}, {3625, 15}, {3629, 20}, {3638, 20}, {3643, 25}, {3652, 30}, {3652, 35}, {3656, 40}, {3656, 79}, {3656, 119}, {3656, 138}, {3647, 148}, {3634, 173}, {3625, 183}, {3607, 203}, {3598, 218}, {3584, 232}, {3566, 252}, {3530, 282}, {3512, 297}, {3498, 316}, {3480, 331}, {3466, 346}, {3448, 356}, {3444, 366}, {3439, 366}, {3435, 371}, {3426, 376}, {3408, 395}, {3398, 400}, {3385, 415}, {3385, 420}, {3403, 445}, {3412, 455}, {3426, 465}, {3439, 479}, {3448, 484}, {3457, 494}, {3475, 514}, {3484, 529}, {3494, 539}, {3507, 549}, {3516, 568}, {3525, 573}, {3530, 578}, {3543, 593}, {3557, 603}, {3566, 613}, {3575, 618}, {3580, 628}, {3611, 652}, {3616, 662}, {3625, 667}, {3629, 677}, {3638, 687}, {3661, 712}, {3670, 721}, {3675, 731}, {3688, 741}, {3693, 751}, {3697, 751}, {3702, 756}, {3706, 761}, {3706, 766}, {3715, 766}, {3720, 771}, {3729, 776}, {3747, 791}, {3752, 796}, {3756, 796}, {3761, 800}, {3770, 796}, {3801, 766}, {3824, 746}, {3856, 721}, {3865, 712}, {3878, 707}, {3896, 692}, {3914, 682}, {3933, 667}, {3946, 662}, {3955, 652}, {3969, 647}, {3982, 633}, {3991, 633}, {4014, 618}, {4046, 618}, {4068, 618}, {4082, 642}, {4086, 647}, {4086, 667}, {4091, 682}, {4091, 721}, {4096, 746}, {4096, 761}, {4096, 786}, {4096, 805}, {4096, 825}, {4086, 840}, {4068, 875}, {4055, 889}, {4041, 904}, {4028, 914}, {4019, 929}, {4010, 934}, {4005, 939}, {3991, 944}, {3982, 954}, {3964, 959}, {3946, 968}, {3905, 998}, {3874, 1018}, {3856, 1038}, {3838, 1047}, {3833, 1052}, {3819, 1062}, {3801, 1072}, {3788, 1077}, {3774, 1087}, {3756, 1097}, {3724, 1117}, {3711, 1117}, {3679, 1127}, {3666, 1127}, {3652, 1131}, {3638, 1131}, {3625, 1131}, {3616, 1131}, {3602, 1136}, {3589, 1136}, {3557, 1136}, {3543, 1136}, {3534, 1136}, {3525, 1141}, {3516, 1141}, {3494, 1141}, {3484, 1146}, {3471, 1146}, {3448, 1156}, {3439, 1156}, {3408, 1166}, {3389, 1176}, {3358, 1191}, {3344, 1206}, {3326, 1215}, {3313, 1225}, {3281, 1255}, {3272, 1260}, {3258, 1275}, {3240, 1290}, {3213, 1319}, {3199, 1329}, {3172, 1359}, {3159, 1364}, {3136, 1388}, {3127, 1393}, {3122, 1398}, {3109, 1408}, {3091, 1428}, {3082, 1433}, {3077, 1443}, {3059, 1458}, {3055, 1467}, {3036, 1487}, {3027, 1492}, {3009, 1507}, {3005, 1512}, {2996, 1512}, {2978, 1522}, {2969, 1522}, {2959, 1527}, {2955, 1527}, {2946, 1532}, {2928, 1532}, {2905, 1532}, {2855, 1497}, {2837, 1487}, {2824, 1467}, {2810, 1453}, {2806, 1438}, {2797, 1418}, {2774, 1383}, {2765, 1364}, {2760, 1359}, {2756, 1349}, {2751, 1339}, {2747, 1324}, {2729, 1294}, {2724, 1285}, {2711, 1270}, {2697, 1255}, {2670, 1235}, {2665, 1225}, {2656, 1220}, {2638, 1210}, {2629, 1196}, {2620, 1191}, {2611, 1191}, {2611, 1186}, {2606, 1186}, {2588, 1166}, };
path_t path4[] = {{3045, 2712}, {3032, 2772}, {3023, 2791}, {3014, 2816}, {2996, 2846}, {2982, 2875}, {2964, 2905}, {2946, 2935}, {2928, 2964}, {2905, 2989}, {2892, 3004}, {2883, 3009}, {2878, 3014}, {2855, 3038}, {2842, 3048}, {2837, 3058}, {2833, 3063}, {2819, 3078}, {2810, 3093}, {2792, 3112}, {2792, 3117}, {2787, 3117}, {2787, 3122}, {2783, 3127}, {2783, 3137}, {2778, 3137}, {2778, 3142}, {2778, 3157}, {2792, 3167}, {2806, 3177}, {2819, 3187}, {2833, 3196}, {2837, 3196}, {2846, 3206}, {2855, 3211}, {2860, 3221}, {2887, 3236}, {2892, 3241}, {2901, 3246}, {2905, 3251}, {2919, 3256}, {2932, 3271}, {2937, 3271}, {2941, 3275}, {2946, 3280}, {2959, 3295}, {2969, 3305}, {2973, 3315}, {2987, 3330}, {2991, 3340}, {3000, 3359}, {3018, 3394}, {3018, 3399}, {3023, 3409}, {3023, 3414}, {3032, 3434}, {3032, 3443}, {3036, 3453}, {3041, 3468}, {3064, 3508}, {3073, 3527}, {3077, 3537}, {3077, 3542}, {3086, 3562}, {3091, 3577}, {3104, 3601}, {3109, 3616}, {3118, 3636}, {3122, 3651}, {3127, 3666}, {3127, 3671}, {3131, 3681}, {3131, 3685}, {3136, 3700}, {3141, 3715}, {3145, 3725}, {3145, 3740}, {3150, 3750}, {3150, 3765}, {3154, 3779}, {3154, 3789}, {3159, 3794}, {3159, 3799}, {3159, 3809}, {3163, 3819}, {3163, 3824}, {3168, 3829}, {3168, 3839}, {3172, 3844}, {3177, 3853}, {3190, 3868}, {3195, 3878}, {3199, 3883}, {3199, 3888}, {3208, 3893}, {3213, 3898}, {3222, 3908}, {3222, 3913}, {3227, 3913}, {3236, 3923}, {3245, 3928}, {3258, 3937}, {3272, 3942}, {3285, 3952}, {3294, 3957}, {3308, 3967}, {3344, 3987}, {3362, 3997}, {3380, 4002}, {3389, 4007}, {3430, 4021}, {3439, 4026}, {3462, 4036}, {3475, 4046}, {3498, 4056}, {3512, 4061}, {3525, 4061}, {3530, 4066}, {3539, 4066}, {3561, 4076}, {3580, 4076}, {3589, 4081}, {3598, 4081}, {3607, 4086}, {3629, 4086}, {3638, 4086}, {3647, 4091}, {3661, 4091}, {3688, 4091}, {3697, 4091}, {3702, 4091}, {3702, 4086}, {3702, 4081}, {3688, 4061}, {3661, 4041}, {3647, 4036}, {3638, 4031}, {3620, 4016}, {3611, 4016}, {3602, 4007}, {3584, 3997}, {3557, 3987}, {3543, 3972}, {3525, 3952}, {3516, 3942}, {3503, 3928}, {3489, 3913}, {3480, 3903}, {3466, 3893}, {3453, 3873}, {3435, 3863}, {3430, 3853}, {3421, 3849}, {3412, 3839}, {3403, 3834}, {3394, 3824}, {3389, 3824}, {3376, 3809}, {3362, 3794}, {3362, 3789}, {3358, 3789}, {3358, 3774}, {3353, 3774}, {3353, 3769}, {3353, 3745}, {3362, 3735}, {3371, 3725}, {3380, 3715}, {3389, 3700}, {3403, 3690}, {3417, 3681}, {3430, 3671}, {3439, 3656}, {3462, 3631}, {3475, 3611}, {3498, 3587}, {3503, 3582}, {3512, 3567}, {3539, 3542}, {3548, 3532}, {3557, 3527}, {3561, 3518}, {3584, 3493}, {3593, 3473}, {3602, 3463}, {3611, 3448}, {3625, 3419}, {3643, 3394}, {3647, 3384}, {3666, 3369}, {3670, 3359}, {3693, 3350}, {3697, 3340}, {3711, 3335}, {3720, 3330}, {3729, 3330}, {3733, 3330}, {3738, 3325}, {3765, 3325}, {3779, 3320}, {3792, 3320}, {3797, 3320}, {3801, 3325}, {3810, 3330}, {3815, 3335}, {3824, 3345}, {3828, 3354}, {3838, 3364}, {3842, 3374}, {3851, 3379}, {3865, 3399}, {3874, 3404}, {3878, 3414}, {3887, 3419}, {3892, 3424}, {3914, 3438}, {3924, 3438}, {3928, 3443}, {3937, 3448}, {3946, 3453}, {3960, 3458}, {3969, 3463}, {3987, 3468}, {4000, 3473}, {4010, 3478}, {4028, 3478}, {4032, 3483}, {4041, 3483}, {4050, 3488}, {4055, 3488}, {4064, 3493}, {4073, 3493}, {4077, 3498}, {4086, 3498}, {4086, 3503}, {4086, 3498}, {4086, 3478}, {4082, 3463}, {4082, 3453}, {4077, 3448}, {4077, 3438}, {4068, 3424}, {4064, 3414}, {4050, 3389}, {4041, 3369}, {4032, 3359}, {4028, 3350}, {4019, 3330}, {3996, 3280}, {3978, 3256}, {3973, 3241}, {3964, 3231}, {3960, 3216}, {3951, 3206}, {3942, 3191}, {3933, 3182}, {3924, 3172}, {3919, 3167}, {3910, 3162}, {3905, 3157}, {3896, 3152}, {3887, 3142}, {3869, 3137}, {3856, 3132}, {3842, 3127}, {3819, 3112}, {3801, 3107}, {3792, 3098}, {3774, 3093}, {3770, 3093}, {3752, 3083}, {3742, 3083}, {3733, 3078}, {3724, 3078}, {3720, 3073}, {3711, 3073}, {3702, 3068}, {3688, 3068}, {3666, 3058}, {3638, 3048}, {3620, 3038}, {3616, 3038}, {3602, 3028}, {3593, 3028}, {3584, 3024}, {3566, 3014}, {3552, 3009}, {3543, 3009}, {3539, 3004}, {3525, 3004}, {3521, 2999}, {3507, 2999}, {3507, 2994}, {3498, 2994}, {3471, 2994}, {3457, 2989}, {3412, 2974}, {3385, 2959}, {3376, 2949}, {3371, 2949}, {3362, 2935}, {3344, 2925}, {3308, 2895}, {3294, 2885}, {3276, 2865}, {3217, 2801}, {3208, 2791}, {3199, 2786}, {3181, 2762}, {3172, 2757}, {3168, 2747}, {3159, 2742}, {3145, 2727}, {3136, 2722}, {3131, 2717}, {3127, 2717}, {3127, 2712}, {3122, 2712}, {3118, 2707}, {3109, 2707}, {3104, 2702}, {3095, 2702}, {3091, 2697}, {3064, 2697}, {3045, 2712}, {3050, 2693}, {3041, 2693}, {3045, 2693}, };
path_t path5[] = {{1407, 2055}, {1448, 2026}, {1475, 2021}, {1484, 2016}, {1502, 2016}, {1511, 2011}, {1520, 2011}, {1529, 2011}, {1570, 2011}, {1633, 2011}, {1656, 2011}, {1661, 2011}, {1670, 2016}, {1679, 2016}, {1692, 2021}, {1701, 2021}, {1706, 2026}, {1715, 2026}, {1719, 2031}, {1728, 2035}, {1737, 2040}, {1742, 2040}, {1751, 2050}, {1756, 2050}, {1756, 2055}, {1765, 2060}, {1778, 2075}, {1778, 2080}, {1783, 2085}, {1783, 2090}, {1787, 2100}, {1787, 2110}, {1792, 2115}, {1796, 2124}, {1796, 2139}, {1801, 2144}, {1801, 2154}, {1805, 2154}, {1805, 2174}, {1810, 2179}, {1810, 2208}, {1814, 2208}, {1814, 2228}, {1814, 2253}, {1814, 2258}, {1814, 2263}, {1810, 2268}, {1810, 2273}, {1805, 2278}, {1805, 2282}, {1796, 2287}, {1796, 2292}, {1792, 2292}, {1783, 2302}, {1774, 2302}, {1756, 2312}, {1751, 2312}, {1733, 2322}, {1724, 2322}, {1710, 2327}, {1706, 2327}, {1697, 2332}, {1688, 2332}, {1670, 2342}, {1647, 2347}, {1638, 2347}, {1633, 2352}, {1624, 2357}, {1620, 2362}, {1602, 2371}, {1593, 2381}, {1588, 2381}, {1584, 2391}, {1575, 2396}, {1561, 2411}, {1556, 2421}, {1547, 2431}, {1543, 2441}, {1529, 2455}, {1529, 2460}, {1525, 2460}, {1525, 2465}, {1516, 2475}, {1516, 2480}, {1511, 2480}, {1507, 2485}, {1498, 2495}, {1493, 2505}, {1479, 2515}, {1470, 2525}, {1457, 2530}, {1434, 2544}, {1416, 2544}, {1412, 2549}, {1384, 2549}, {1375, 2544}, {1371, 2544}, {1366, 2539}, {1362, 2539}, {1357, 2534}, {1353, 2534}, {1339, 2525}, {1335, 2525}, {1317, 2505}, {1317, 2500}, {1312, 2495}, {1303, 2480}, {1298, 2455}, {1294, 2450}, {1294, 2441}, {1289, 2431}, {1289, 2406}, {1289, 2352}, {1289, 2292}, {1289, 2268}, {1289, 2258}, {1298, 2238}, {1303, 2223}, {1303, 2203}, {1307, 2199}, {1312, 2189}, {1312, 2174}, {1321, 2164}, {1330, 2144}, {1339, 2134}, {1348, 2115}, {1353, 2110}, {1357, 2100}, {1362, 2095}, {1362, 2085}, {1371, 2080}, {1375, 2075}, {1380, 2070}, {1389, 2055}, {1407, 2055}, {1421, 2026}, {1430, 2026}, {1430, 2021}, {1439, 2021}, {1439, 2016}, {1452, 2011}, };
path_t path6[] = {{1964, 2683}, {1968, 2663}, {1973, 2663}, {1973, 2658}, {1977, 2653}, {1982, 2648}, {1986, 2648}, {1995, 2643}, {2000, 2638}, {2009, 2633}, {2023, 2623}, {2032, 2623}, {2036, 2618}, {2045, 2618}, {2059, 2618}, {2077, 2613}, {2100, 2613}, {2109, 2613}, {2113, 2618}, {2118, 2618}, {2118, 2623}, {2122, 2623}, {2127, 2628}, {2131, 2633}, {2131, 2643}, {2136, 2648}, {2136, 2653}, {2140, 2663}, {2140, 2668}, {2145, 2678}, {2145, 2697}, {2149, 2707}, {2149, 2722}, {2149, 2757}, {2149, 2772}, {2149, 2781}, {2154, 2791}, {2154, 2806}, {2154, 2846}, {2154, 2856}, {2158, 2865}, {2158, 2885}, {2158, 2930}, {2158, 2944}, {2154, 2944}, {2149, 2949}, {2145, 2949}, {2131, 2954}, {2109, 2954}, {2090, 2954}, {2086, 2949}, {2081, 2949}, {2081, 2940}, {2072, 2930}, {2063, 2910}, {2059, 2910}, {2059, 2905}, {2054, 2905}, {2054, 2900}, {2050, 2895}, {2036, 2890}, {2014, 2890}, {2005, 2905}, {1991, 2920}, {1991, 2925}, {1977, 2940}, {1973, 2940}, {1964, 2944}, {1959, 2944}, {1950, 2949}, {1928, 2949}, {1919, 2949}, {1914, 2949}, {1914, 2944}, {1905, 2940}, {1905, 2920}, {1900, 2905}, {1900, 2890}, {1900, 2875}, {1900, 2831}, {1900, 2811}, {1905, 2796}, {1909, 2767}, {1923, 2742}, {1937, 2727}, {1941, 2722}, {1941, 2717}, {1964, 2683}, };
path_t path7[] = {{1077, 1517}, {1050, 1482}, {1045, 1467}, {1036, 1457}, {1027, 1448}, {1022, 1443}, {1018, 1433}, {1013, 1428}, {1009, 1418}, {1004, 1418}, {1004, 1408}, {1000, 1403}, {995, 1393}, {982, 1378}, {977, 1369}, {968, 1359}, {964, 1349}, {959, 1344}, {954, 1344}, {950, 1334}, {945, 1334}, {941, 1324}, {932, 1319}, {927, 1309}, {918, 1304}, {909, 1294}, {900, 1290}, {896, 1285}, {878, 1275}, {864, 1260}, {850, 1255}, {828, 1240}, {787, 1225}, {773, 1220}, {742, 1206}, {733, 1201}, {701, 1191}, {687, 1181}, {678, 1181}, {665, 1176}, {647, 1171}, {629, 1161}, {588, 1151}, {552, 1141}, {538, 1136}, {525, 1136}, {493, 1122}, {484, 1117}, {475, 1117}, {457, 1107}, {429, 1097}, {420, 1092}, {380, 1077}, {366, 1072}, {353, 1062}, {321, 1052}, {307, 1043}, {294, 1038}, {285, 1028}, {262, 1008}, {244, 998}, {221, 978}, {212, 973}, {203, 963}, {190, 954}, {181, 944}, {162, 924}, {153, 914}, {140, 904}, {135, 899}, {113, 875}, {90, 855}, {72, 835}, {63, 825}, {49, 800}, {40, 791}, {40, 781}, {36, 771}, {36, 766}, {31, 751}, {31, 736}, {27, 716}, {27, 692}, {27, 672}, {27, 642}, {27, 628}, {31, 613}, {31, 603}, {36, 598}, {40, 593}, {45, 593}, {45, 588}, {49, 588}, {58, 588}, {67, 588}, {85, 598}, {104, 603}, {113, 613}, {135, 623}, {144, 633}, {167, 652}, {181, 667}, {203, 682}, {212, 687}, {221, 697}, {230, 702}, {248, 712}, {267, 721}, {276, 726}, {280, 726}, {289, 731}, {298, 731}, {312, 736}, {330, 736}, {343, 736}, {362, 736}, {375, 731}, {393, 726}, {429, 716}, {461, 707}, {466, 702}, {470, 702}, {475, 697}, {488, 692}, {502, 682}, {543, 662}, {556, 657}, {579, 637}, {588, 633}, {601, 608}, {611, 598}, {615, 583}, {624, 558}, {624, 549}, {633, 524}, {633, 519}, {638, 504}, {638, 489}, {642, 474}, {642, 460}, {647, 445}, {647, 420}, {647, 381}, {647, 356}, {647, 341}, {642, 331}, {638, 316}, {629, 306}, {624, 297}, {615, 287}, {611, 277}, {597, 262}, {579, 242}, {556, 218}, {543, 203}, {529, 193}, {525, 183}, {511, 173}, {497, 163}, {488, 158}, {479, 143}, {470, 129}, {466, 124}, {466, 119}, {461, 109}, {452, 99}, {452, 69}, {452, 30}, {452, 15}, {457, 10}, {457, 5}, {461, 5}, {466, 0}, {470, 0}, {479, 0}, {520, 5}, {552, 15}, {583, 25}, {611, 40}, {629, 50}, {656, 69}, {669, 79}, {678, 89}, {701, 104}, {710, 114}, {733, 124}, {746, 138}, {760, 143}, {769, 148}, {778, 153}, {801, 178}, {810, 183}, {819, 193}, {828, 203}, {837, 213}, {841, 227}, {846, 227}, {859, 252}, {873, 267}, {882, 282}, {891, 297}, {900, 316}, {909, 331}, {918, 346}, {927, 366}, {945, 395}, {950, 415}, {964, 445}, {968, 460}, {973, 469}, {991, 519}, {1000, 539}, {1004, 558}, {1013, 588}, {1022, 608}, {1031, 647}, {1045, 682}, {1050, 702}, {1059, 712}, {1059, 721}, {1063, 726}, {1072, 741}, {1081, 761}, {1090, 771}, {1108, 800}, {1131, 825}, {1140, 835}, {1149, 840}, {1154, 850}, {1167, 860}, {1181, 880}, {1208, 899}, {1222, 919}, {1235, 924}, {1240, 934}, {1253, 944}, {1262, 954}, {1271, 959}, {1285, 968}, {1289, 973}, {1294, 973}, {1308, 983}, {1326, 993}, {1330, 1003}, {1353, 1013}, {1357, 1018}, {1375, 1038}, {1384, 1043}, {1389, 1047}, {1393, 1047}, {1403, 1062}, {1416, 1072}, {1421, 1082}, {1425, 1082}, {1425, 1092}, {1430, 1092}, {1430, 1097}, {1430, 1102}, {1430, 1156}, {1430, 1166}, {1430, 1176}, {1416, 1196}, {1412, 1210}, {1403, 1220}, {1384, 1240}, {1371, 1250}, {1348, 1275}, {1312, 1314}, {1303, 1324}, {1276, 1344}, {1262, 1359}, {1235, 1378}, {1226, 1388}, {1212, 1403}, {1203, 1413}, {1185, 1423}, {1167, 1443}, {1158, 1448}, {1154, 1453}, {1140, 1467}, {1131, 1477}, {1122, 1482}, {1113, 1492}, {1104, 1497}, {1077, 1517}, {1059, 1507}, {1054, 1507}, {1040, 1492}, {1036, 1482}, {1027, 1472}, };
path_t *paths[] = {path0, path1, path2, path3, path4, path5, path6, path7};
size_t pathLens[] = {sizeof(path0)/sizeof(path_t), sizeof(path1)/sizeof(path_t), sizeof(path2)/sizeof(path_t), sizeof(path3)/sizeof(path_t), sizeof(path4)/sizeof(path_t), sizeof(path5)/sizeof(path_t), sizeof(path6)/sizeof(path_t), sizeof(path7)/sizeof(path_t)};



// static int16_t xOff, yOff;
// static int8_t xSpd, ySpd;

static uint32_t pathIndex = 0;
static uint32_t currentPath = 0;

void controlLoopInit() {
	// xSpd = 20;
	// ySpd = -24;

	TIM_TimeBaseInitTypeDef timerConfig;

	// Power the timer
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_TIM9, ENABLE);

	//
	// Configure timer for 100us period
	//
	TIM_TimeBaseStructInit(&timerConfig);

	timerConfig.TIM_Period = 33;
	timerConfig.TIM_Prescaler = 168;
	timerConfig.TIM_ClockDivision = 0;
	timerConfig.TIM_CounterMode = TIM_CounterMode_Up;

	TIM_TimeBaseInit(TIM9, &timerConfig);

	TIM_ITConfig(TIM9, TIM_IT_Update, ENABLE);

	NVIC_EnableIRQ(TIM1_BRK_TIM9_IRQn);

	// Enable the timer!
	TIM_Cmd(TIM9, ENABLE);
}

void TIM1_BRK_TIM9_IRQHandler(void) {
	uint32_t sr = TIM9->SR;
	TIM9->SR &= ~sr;

	if(sr & TIM_FLAG_Update) {
		switch(currentState) {
			case DRAWING: {
				galvoSet(0, paths[currentPath][pathIndex].x/2 + 256);
				galvoSet(1, paths[currentPath][pathIndex].y/2 + 256);
				GPIO_SetBits(GPIOD, GPIO_Pin_8);
				
				pathIndex += 1;

				if(pathIndex >= pathLens[currentPath]) {
					// Laser off?
					pathIndex = 0;
					GPIO_ResetBits(GPIOD, GPIO_Pin_8);

					// Queue the next path for drawing
					currentPath++;

					// Wrap around if necsesary
					if(currentPath >= sizeof(paths)/sizeof(path_t *)) {
						currentPath = 0;
					}

					// Start moving to the first point on the next path
					galvoSet(0, paths[currentPath][pathIndex].x/2 + 256);
					galvoSet(1, paths[currentPath][pathIndex].y/2 + 256);

					movingDelay = MOVING_PERIOD;
					currentState = MOVING;
				}

				break;
			}

			case MOVING: {
				if(--movingDelay == 0) {
					currentState = DRAWING;
				}
				break;
			}
		}
	}
}

int main(void) {
	uint32_t nextBlink;
	// uint32_t nextMove;

	uint32_t blinkState = 0;
	init();

	// Disable line buffering on stdout
	setbuf(stdout, NULL);

	nextBlink = tickMs + BLINK_DELAY_MS;
	// nextMove = tickMs + MOVE_DELAY_MS;
	for(;;) {

		consoleProcess();

		if(tickMs > nextBlink) {
			nextBlink = tickMs + BLINK_DELAY_MS;
			if(blinkState) {
				GPIO_SetBits(GPIOD, GPIO_Pin_12);
			} else {
				GPIO_ResetBits(GPIOD, GPIO_Pin_12);
			}
			blinkState ^= 1;
		}

		// if(tickMs > nextMove) {
		// 	nextMove = tickMs + MOVE_DELAY_MS;
			
		// 	pathIndex = 0;

		// 	xOff += xSpd;
		// 	if(xOff >= XOFFMAX) {
		// 		xOff = XOFFMAX;
		// 		xSpd = -xSpd;
		// 	} else if(xOff <= XOFFMIN) {
		// 		xOff = XOFFMIN;
		// 		xSpd = -xSpd;
		// 	}

		// 	yOff += ySpd;
		// 	if(yOff >= YOFFMAX) {
		// 		yOff = YOFFMAX;
		// 		ySpd = -ySpd;
		// 	} else if(yOff <= YOFFMIN) {
		// 		yOff = YOFFMIN;
		// 		ySpd = -ySpd;
		// 	}

		// }

		__WFI();
		
	}

	return 0;
}

void init() {

	// ---------- SysTick timer -------- //
	if (SysTick_Config(SystemCoreClock / 1000)) {
		// Capture error
		while (1){};
	}

	// ---------- GPIO -------- //
	// GPIOD Periph clock enable
	RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOD, ENABLE);

	GPIO_Init(GPIOD, &(GPIO_InitTypeDef){GPIO_Pin_12, GPIO_Mode_OUT, GPIO_Speed_2MHz, GPIO_OType_PP, GPIO_PuPd_NOPULL});
	GPIO_Init(GPIOD, &(GPIO_InitTypeDef){GPIO_Pin_14, GPIO_Mode_OUT, GPIO_Speed_2MHz, GPIO_OType_PP, GPIO_PuPd_NOPULL});

	consoleInit();

	USBD_Init(&USB_OTG_dev,
				USB_OTG_FS_CORE_ID,
				&USR_desc,
				&USBD_CDC_cb,
				&USR_cb);

	controlLoopInit();
}

void SysTick_Handler(void)
{
	tickMs++;
}
